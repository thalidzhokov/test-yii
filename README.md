# Messenger API

API для обработки webhook-сообщений мессенджера на Yii2 + PostgreSQL

## Запуск

### Переменные окружения
Сконфигурируйте настройки в файле `.env`, если это необходимо


### Запуск контейнеров
```bash
docker compose up -d --build
docker exec -ti test-yii-php sh -c 'php yii migrate --interactive=0'
```

## API
**POST /api/v1/webhook** - обработка сообщений

### Пример запроса:
```json
{
    "external_message_id": "1a2b3c4d5e6f7890abcdef1234567890",
    "external_client_id": "fedcba0987654321abcdef1234567890",
    "client_phone": "+79194961182",
    "message_text": "Привет!",
    "send_at": 1640995200
}
```

```bash
curl -X POST http://localhost/api/v1/webhook -H "Content-Type: application/json" -d '{"external_message_id":"1a2b3c4d5e6f7890abcdef1234567890", "external_client_id":"fedcba0987654321abcdef1234567890","client_phone":"+79194961182","message_text":"Привет!","send_at":1640995200}'
```

## Структура
- **controllers/ApiController.php** - основной контроллер api
- **services/WebhookService.php** - сервис обработки webhook
- **models/** - модели данных (Client, Dialog, Message)
- **migrations/** - миграция создания таблиц бд (опционально можно реализовать через инит бд)


## Ниже вольное изложение видения архитектуры и доработок, НО исходить стоит из задач бизнеса и доступных ресурсов
Все что описано ниже как предмет для диалога и поиска правильных решений в рамках существующей архитектуры, инфраструктуры и подходов к разработке

## Не реализованная функциональность

### Возможно, критично для прода или тестировщиков и аналитиков:
- Отключен CSRF в ApiController
- Нет свагера

### Redis функциональность
- **services/RedisService.php** - логика и методы
- **Кеширование**: объекты в redis, валидации regex, статистика в redis
    - **Обработка дублей сообщений** - проверка повторных external_message_id
    - **Кеширование клиентов** - избежание запросов к бд для частых клиентов  
    - **Кеширование диалогов** - связи client_id->dialog_id
    - **Кеширование валидации** - результаты проверок регулярными выражениями
    - **Метрики в реальном времени** - счетчики обработанных сообщений

### Асинхронная обработка
- **commands/WebhookWorkerController.php** - консольные команды
- **Очереди webhook** - основная, повторная, проблемные сообщения (возможно стоит писать в логи?)
- **Балансировка нагрузки** - распределение задач между воркерами
- **Supervisor конфигурация** - автозапуск и контроль воркеров
Как вариант сравнить отработку асинхронки с, например, python+async+fastapi, если бюджеты и сроки позволяют сравнивать технологии в разном стеке :)

### Производительность и мониторинг
- **Rate limit** - защита от флуда по ip/клиенту
- **Логирование** - грейлог, структурированные логи в json формате
- **Метрики** - Zabbix/Prometheus/Grafana для мониторинга
- **Профилирование** - XHProf для анализа узких мест
- **Мониторинг соединений** к бд и redis

### Отказоустойчивость
- **Health checks** - проверки состояния сервисов и приложения
- **Backup и восстановление** - логика и инструменты резервного копирования

## Хайлоад

### Архитектурные доработки
1. **Асинхронная архитектура**:
   - Разделить прием webhook и обработку через очереди
   - Использовать redis для очередей
   - Запускать несколько воркеров через supervisor

2. **Redis кластер**: шардирование (redis) или партиционирование(возможно +шардирование, keydb) по нодам по клиентам, отдельно изучить на тачках приближенных к боевым (архитектурный уровень, бареметал, облака, распределенная ифраструктура без внутренних сетей итд.) 

3. **Оптимизация и кластеризация БД**:
   - Партиционирование таблиц бд, напр., messages по времени
   - Индексы для частых запросов (составные/партиционированные индексы)

### Инфраструктура
1. **Load Balancer** (скорее всего потребуется если: забивается канал, при проблемах производительности диска/памяти, нехватке цпу)

2. **Горизонтальное масштабирование**:
   - Несколько инстансов php-fpm
   - Автоскейлинг по cpu/ram

3. **Мониторинг**:
   - Метрики приложения (время ответа, рпс, ошибки)
   - Системные метрики (цпу, память, диск, сеть) на zabbix/grafana/ином решении
   - Бизнес-метрики (обработанные сообщения, активные клиенты, ... ??? кому и как отдавать?)

### К производительности
**Групповая обработка сообщений** (возможно не нужно, требует отдельного изучения в среде схожей продом): по 100-1000 штук в Redis, PostgreSQL

### Тестирование нагрузки
1. **Бенчмарки** - тестирование api, кеша, бд

**Итог**: Задача комплексная с учетом хайлоада, проработка может быть в каждой детали кода, инфрастрктуры, архитектуры 
